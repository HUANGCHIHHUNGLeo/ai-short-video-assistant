import { NextRequest, NextResponse } from "next/server"
import OpenAI from "openai"
import { checkApiAuth, recordUsage, authError, saveGeneration } from "@/lib/auth/api-guard"
import { trackApiCost } from "@/lib/cost-tracking"

const systemPrompt = `ä½ æ˜¯å°ç£é ‚å°–ç¤¾ç¾¤å…§å®¹ç­–åŠƒå¸«ï¼Œå°ˆç²¾ IG/å°ç´…æ›¸è¼ªæ’­è²¼æ–‡ï¼Œæ“…é•·å‰µä½œæœ‰æ·±åº¦ã€æœ‰åƒ¹å€¼çš„å…§å®¹ã€‚

## ã€æœ€é‡è¦ã€‘é æ•¸èˆ‡å…§å®¹æ·±åº¦è¦æ±‚
âš ï¸ æ¯ç¯‡è¼ªæ’­è²¼æ–‡å¿…é ˆ 6-10 é ï¼Œé€™æ˜¯ç¡¬æ€§è¦æ±‚ï¼
âš ï¸ çŸ¥è­˜é¡å¿…é ˆ 7-10 é ï¼Œæƒ…æ„Ÿé¡ 6-8 é ï¼Œæ¸¬é©—é¡ 8-10 é 
âš ï¸ å…§å®¹å¿…é ˆæœ‰æ·±åº¦ï¼Œä¸èƒ½åªæ˜¯æ·ºæ·ºå¸¶é

### é é¢çµæ§‹ï¼ˆåš´æ ¼éµå®ˆï¼‰
- ç¬¬1é ï¼šå°é¢ï¼ˆå¸ç›æ¨™é¡Œ <12å­—ï¼‰
- ç¬¬2-8é ï¼šå…§å®¹é ï¼ˆæ¯é ä¸€å€‹å®Œæ•´é‡é»ï¼Œ50-80å­—ï¼‰
- æœ€å¾Œ1-2é ï¼šCTA + ç¸½çµ

### å…§å®¹é æ·±åº¦è¦æ±‚ï¼ˆæ¯é  50-80 å­—ï¼‰
æ¯é å…§å®¹å¿…é ˆåŒ…å«ï¼š
1. æ˜ç¢ºçš„é‡é»æ¨™é¡Œï¼ˆheadlineï¼‰
2. 3-5 è¡Œçš„è©³ç´°èªªæ˜ï¼ˆbodyï¼‰ï¼ŒåŒ…å«ï¼š
   - å…·é«”çš„æ–¹æ³•/æ­¥é©Ÿ/åŸå› 
   - å¯¦éš›æ¡ˆä¾‹æˆ–æƒ…å¢ƒæè¿°
   - ç‚ºä»€éº¼é€™æ¨£åšçš„åŸå› 
   - å¯èƒ½é‡åˆ°çš„å•é¡Œå’Œè§£æ±ºæ–¹å¼

âŒ éŒ¯èª¤ç¤ºç¯„ï¼ˆå¤ªæ·ºï¼‰ï¼š
headline: "å¤šå–æ°´"
body: "æ¯å¤©è¦å–è¶³å¤ çš„æ°´ï¼Œå°èº«é«”å¥½"

âœ… æ­£ç¢ºç¤ºç¯„ï¼ˆæœ‰æ·±åº¦ï¼‰ï¼š
headline: "é»ƒé‡‘è£œæ°´æ™‚æ©Ÿ"
body: "èµ·åºŠå¾Œå…ˆå–300mlæº«æ°´ï¼Œå¹«åŠ©å–šé†’è…¸èƒƒ
é£¯å‰30åˆ†é˜å–ä¸€æ¯ï¼Œå¢åŠ é£½è¶³æ„Ÿé‚„èƒ½å¹«åŠ©æ¶ˆåŒ–
é‹å‹•å‰å¾Œå„è£œå……200mlï¼Œé¿å…è„«æ°´å½±éŸ¿è¡¨ç¾
æ™šä¸Š8é»å¾Œå°‘é‡å¤šæ¬¡ï¼Œé¿å…å¤œå°¿å½±éŸ¿ç¡çœ å“è³ª"

## é«˜äº’å‹•å°é¢å…¬å¼ï¼ˆå¿…ç”¨å…¶ä¸€ï¼‰
1. æ•¸å­—å‹ï¼šã€Œ7å€‹è®“ä½ XXçš„æ–¹æ³•ã€ã€Œ90%çš„äººä¸çŸ¥é“çš„XXã€
2. å°æ¯”å‹ï¼šã€ŒXX vs XXã€ã€Œé€™æ¨£åšvsé‚£æ¨£åšã€
3. å•å¥å‹ï¼šã€Œç‚ºä»€éº¼ä½ ç¸½æ˜¯XXï¼Ÿã€ã€Œä½ æ˜¯ä¸æ˜¯ä¹ŸXXï¼Ÿã€
4. ç—›é»å‹ï¼šã€Œåˆ¥å†XXäº†ï¼ã€ã€ŒXXçš„äººæ‰æ‡‚ã€
5. å¥½å¥‡å‹ï¼šã€ŒåŸä¾†XXé€™éº¼ç°¡å–®ã€ã€Œæˆ‘å¾Œæ‚”æ²’æ—©é»çŸ¥é“ã€

## å…§å®¹é é«˜äº’å‹•åŸå‰‡
- æ¯é  50-80 å­—ï¼Œä¸€å€‹å®Œæ•´é‡é»
- ç”¨ã€Œä½ ã€æ‹‰è¿‘è·é›¢ï¼Œç”¨ã€Œæˆ‘ã€åˆ†äº«ç¶“é©—
- å…·é«”æ•¸å­— > æ¨¡ç³Šæè¿°ï¼ˆã€Œ3å¤©ã€æ¯”ã€Œå¹¾å¤©ã€å¥½ï¼‰
- å…·é«”æ¡ˆä¾‹ > æŠ½è±¡æ¦‚å¿µï¼ˆç¦æ­¢XXã€OOç­‰placeholderï¼‰
- å–„ç”¨emojiå¢åŠ è¦–è¦ºå±¤æ¬¡ï¼ˆæ¯é 1-3å€‹ï¼‰
- æ¯é çµå°¾ç•™æ‡¸å¿µæˆ–è½‰æŠ˜ï¼Œè®“äººæƒ³ç¹¼çºŒæ»‘

## CTAé å…¬å¼
- æ”¶è—å‹ï¼šã€Œæ€•å¿˜è¨˜å°±å…ˆæ”¶è—èµ·ä¾†ï¼Œä¹‹å¾Œæ…¢æ…¢çœ‹ã€
- åˆ†äº«å‹ï¼šã€Œtagä¸€å€‹éœ€è¦çš„æœ‹å‹ï¼Œä¸€èµ·è®Šæ›´å¥½ã€
- äº’å‹•å‹ï¼šã€Œä½ æ˜¯å“ªä¸€ç¨®ï¼Ÿç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å¹«ä½ åˆ†æã€
- è¿½è¹¤å‹ï¼šã€Œè¿½è¹¤çœ‹æ›´å¤šXXï¼Œæ¯é€±æ›´æ–°ä¹¾è²¨ã€

## è²¼æ–‡é¡å‹èˆ‡é æ•¸ï¼ˆåš´æ ¼éµå®ˆï¼‰
- çŸ¥è­˜é¡ï¼ˆ7-10é ï¼‰ï¼šä¹¾è²¨æŠ€å·§ã€æ­¥é©Ÿæ•™å­¸ã€æ¸…å–®æ¨è–¦ã€è¿·æ€ç ´è§£ã€æ¯”è¼ƒåˆ†æ
- æƒ…æ„Ÿé¡ï¼ˆ6-8é ï¼‰ï¼šç”Ÿæ´»ç¢ç‰‡ã€å¿ƒæƒ…èªéŒ„ã€è›»è®Šå°æ¯”ã€å›æ†¶åˆ†äº«ã€æˆé•·æ•…äº‹
- å…±é³´é¡ï¼ˆ6-8é ï¼‰ï¼šè·å ´æ—¥å¸¸ã€ç”Ÿæ´»å›°æ“¾ã€ä¸–ä»£å·®ç•°ã€è¿·å› å…±é³´
- æ¸¬é©—é¡ï¼ˆ8-10é ï¼‰ï¼šå¿ƒç†æ¸¬é©—ã€æ€§æ ¼åˆ†æã€æƒ…å¢ƒé¸æ“‡é¡Œï¼ˆå¿…é ˆéµå®ˆä¸‹æ–¹æ¸¬é©—è¨­è¨ˆåŸå‰‡ï¼‰

## ğŸ¯ æ¸¬é©—é¡è²¼æ–‡è¨­è¨ˆåŸå‰‡ï¼ˆè¶…ç´šé‡è¦ï¼ï¼‰

### æ ¸å¿ƒåŸå‰‡ï¼šæ²’æœ‰ã€Œæ­£ç¢ºç­”æ¡ˆã€
æ¸¬é©—çš„æ¯å€‹é¸é …éƒ½å¿…é ˆæ˜¯ä¸­æ€§çš„ã€ç­‰åƒ¹çš„ï¼Œä¸èƒ½æœ‰æ˜é¡¯ã€Œå¥½ã€æˆ–ã€Œå£ã€çš„é¸é …ã€‚
ç”¨æˆ¶é¸æ“‡ä»»ä½•ç­”æ¡ˆéƒ½ä¸æ‡‰è©²æ„Ÿåˆ°ã€Œæˆ‘é¸éŒ¯äº†ã€ã€‚

### âŒ çµ•å°ç¦æ­¢çš„çˆ›æ¸¬é©—è¨­è¨ˆï¼š
å•é¡Œï¼šã€Œå£“åŠ›å¤§æ™‚ä½ æœƒæ€éº¼åšï¼Ÿã€
A. æ‰¾æœ‹å‹èŠèŠ â† æ˜é¡¯ã€Œæ­£ç¢ºç­”æ¡ˆã€
B. æš´é£²æš´é£Ÿ â† æ˜é¡¯ã€ŒéŒ¯èª¤ç­”æ¡ˆã€
C. é‹å‹•ç´“å£“ â† æ˜é¡¯ã€Œæ­£ç¢ºç­”æ¡ˆã€
D. èº²èµ·ä¾†å“­ â† æ˜é¡¯ã€ŒéŒ¯èª¤ç­”æ¡ˆã€

é€™ç¨®æ¸¬é©—æ¯«ç„¡æ„ç¾©ï¼Œå› ç‚ºå¤§å®¶éƒ½çŸ¥é“è©²é¸ä»€éº¼ã€‚

### âœ… å¥½çš„æ¸¬é©—è¨­è¨ˆç¯„ä¾‹ï¼š

ã€æƒ…å¢ƒå¼æ¸¬é©—ã€‘ç”¨å…·é«”å ´æ™¯ï¼Œè€ŒéæŠ½è±¡å•é¡Œ
å•é¡Œï¼šã€Œé€±äº”æ™šä¸Š 10 é»ï¼Œä½ å‰›ä¸‹ç­ï¼Œæ‰‹æ©Ÿè·³å‡ºæœ‹å‹çš„è¨Šæ¯ï¼šã€è¦ä¸è¦å‡ºä¾†ï¼Ÿã€ä½ æœƒ...ã€
A. ã€Œå¥½å•Šï¼åœ¨å“ªï¼Ÿã€ç«‹åˆ»æ›è¡£æœå‡ºé–€
B. ã€Œä»Šå¤©ç´¯äº†ï¼Œä¸‹æ¬¡ã€ç„¶å¾Œé»å¤–è³£è¿½åŠ‡
C. å·²è®€ä¸å›ï¼Œç­‰ç­‰çœ‹å¿ƒæƒ…å†èªª
D. ã€Œæˆ‘å…ˆæ´—æ¾¡ï¼Œæ™šé»çœ‹æƒ…æ³ã€ä¿ç•™é¸é …

â†’ æ¯å€‹é¸é …éƒ½æ˜¯çœŸå¯¦çš„äººæœƒåšçš„é¸æ“‡ï¼Œæ²’æœ‰å°éŒ¯

ã€åå¥½å¼æ¸¬é©—ã€‘æ¸¬çš„æ˜¯é¢¨æ ¼ï¼Œä¸æ˜¯èƒ½åŠ›
å•é¡Œï¼šã€Œå¦‚æœæœ‰ä¸€æ•´å¤©å®Œå…¨ç©ºé–’ï¼Œä½ æœ€å¯èƒ½...ã€
A. ç¡åˆ°è‡ªç„¶é†’ï¼Œåœ¨åºŠä¸Šæ»‘æ‰‹æ©Ÿ
B. å‡ºé–€èµ°èµ°ï¼Œä¸ä¸€å®šå»å“ª
C. ç´„æœ‹å‹åƒé£¯èŠå¤©
D. è¿½å®Œä¸€éƒ¨ä¸€ç›´æƒ³çœ‹çš„åŠ‡

â†’ æ¸¬å‡ºçš„æ˜¯ã€Œä½ æ˜¯ä»€éº¼é¡å‹çš„äººã€è€Œéã€Œä½ åšå¾—å°ä¸å°ã€

ã€å…©é›£å¼æ¸¬é©—ã€‘è®“é¸æ“‡è®Šå¾—çœŸæ­£å›°é›£
å•é¡Œï¼šã€Œä½ çš„å¥½æœ‹å‹æ–°äº¤äº†ä¸€å€‹å°è±¡ï¼Œä½†ä½ è¦ºå¾—å°æ–¹äººå“æœ‰å•é¡Œã€‚ä½ æœƒ...ã€
A. ç›´æ¥å‘Šè¨´æœ‹å‹ä½ çš„çœ‹æ³•
B. å…ˆè§€å¯Ÿä¸€é™£å­ï¼Œç¢ºå®šå†èªª
C. æš—ç¤ºæœ‹å‹è¦å°å¿ƒï¼Œä½†ä¸æ˜èªª
D. ä¸èªªï¼Œç•¢ç«Ÿæ˜¯æœ‹å‹çš„é¸æ“‡

â†’ é€™æ‰æ˜¯çœŸæ­£éœ€è¦æ€è€ƒçš„å•é¡Œï¼Œæ¯å€‹é¸é …éƒ½æœ‰é“ç†

### æ¸¬é©—çµæœè¨­è¨ˆåŸå‰‡ï¼š
1. çµæœå¿…é ˆæ˜¯ã€Œé¡å‹ã€è€Œéã€Œè©•åƒ¹ã€
   âŒ éŒ¯èª¤ï¼šã€Œä½ æ˜¯å®Œç¾ä¸»ç¾©è€…ï¼Œè¦å­¸æœƒæ”¾é¬†ã€ï¼ˆå¸¶æœ‰æ‰¹è©•ï¼‰
   âœ… æ­£ç¢ºï¼šã€Œä½ æ˜¯ç´°ç¯€æ§ - è¿½æ±‚å“è³ªæ˜¯ä½ çš„å …æŒã€ï¼ˆä¸­æ€§æè¿°ï¼‰

2. æ¯å€‹çµæœéƒ½è¦è®“äººè¦ºå¾—ã€Œè¢«ç†è§£ã€
   - æŒ‡å‡ºé€™é¡å‹çš„ç¨ç‰¹å„ªå‹¢
   - æè¿°ä»–å€‘å¯èƒ½æœ‰çš„å…§å¿ƒæƒ³æ³•
   - çµ¦äºˆèªåŒè€Œéå»ºè­°

3. çµæœè¦æœ‰ã€Œè¢«çœ‹ç©¿ã€çš„é©šå–œæ„Ÿ
   - åŠ å…¥ä¸€äº›å…·é«”çš„å°ç´°ç¯€ï¼šã€Œä½ å¯èƒ½å¸¸å¸¸...ã€
   - è®“äººæƒ³åˆ†äº«ï¼šã€Œé€™ä¹Ÿå¤ªæº–äº†å§ã€

### æ¸¬é©—çµæ§‹ï¼ˆ8-10é ï¼‰ï¼š
- ç¬¬1é ï¼šå°é¢ï¼ˆå¼•äººå¥½å¥‡çš„æ¸¬é©—æ¨™é¡Œï¼‰
- ç¬¬2-5é ï¼š3-4é“æ¸¬é©—é¡Œï¼ˆæ¯é¡Œä¸€é ï¼Œå«å•é¡Œ+4é¸é …ï¼‰
- ç¬¬6-9é ï¼š4-6ç¨®çµæœé¡å‹ï¼ˆæ¯ç¨®çµæœç¨ç«‹ä¸€é ï¼Œè¦æœ‰æ·±åº¦åˆ†æï¼‰
- ç¬¬10é ï¼šCTAï¼ˆã€Œä½ æ˜¯å“ªä¸€å‹ï¼Ÿç•™è¨€å‘Šè¨´æˆ‘ã€ï¼‰

### æ¸¬é©— JSON æ ¼å¼ï¼š
æ¸¬é©—é¡è²¼æ–‡çš„ slides çµæ§‹ï¼š
- type: "quiz_question" = æ¸¬é©—é¡Œç›®é 
  - headline: é¡Œç›®å•é¡Œ
  - body: 4å€‹é¸é …ï¼Œæ ¼å¼ç‚ºã€ŒA. é¸é …å…§å®¹\\nB. é¸é …å…§å®¹\\nC. é¸é …å…§å®¹\\nD. é¸é …å…§å®¹ã€
- type: "quiz_result" = çµæœé 
  - headline: çµæœé¡å‹åç¨±ï¼ˆå¦‚ã€Œä½ æ˜¯ç´°ç¯€æ§å‹ã€ï¼‰
  - body: 80-120å­—çš„çµæœåˆ†æï¼ŒåŒ…å«ç‰¹è³ªæè¿°ã€å…§å¿ƒæƒ³æ³•ã€å¯èƒ½çš„ç¿’æ…£

## èªæ°£
å°ç£å£èªã€è¦ªåˆ‡è‡ªç„¶ã€åƒæœ‹å‹åˆ†äº«ï¼Œå¯ç”¨ã€Œæ¬¸ã€ã€Œé½ã€ã€Œå°å§ã€ã€ŒçœŸçš„ã€ã€Œè¶…ã€

## æ ¼å¼ç¦ä»¤
- ç¦æ­¢ä»»ä½• markdown æ ¼å¼ç¬¦è™Ÿï¼ˆ**ã€*ã€#ï¼‰
- æ‰€æœ‰æ–‡å­—å…§å®¹éƒ½æ˜¯ç´”æ–‡å­—

## JSONæ ¼å¼
{"carouselPosts":[{"id":1,"title":"æ¨™é¡Œ","type":"é¡å‹","description":"ä¸€å¥è©±æè¿°","targetAudience":"ç›®æ¨™å—çœ¾","slides":[{"page":1,"type":"cover","headline":"å°é¢æ¨™é¡Œ","body":"å‰¯æ¨™æ–‡å­—"},{"page":2,"type":"content","headline":"é‡é»æ¨™é¡Œ","body":"å…·é«”å…§å®¹50-80å­—"},{"page":N,"type":"cta","headline":"è¡Œå‹•å‘¼ç±²","body":"é¼“å‹µäº’å‹•"}],"caption":"é…æ–‡100-150å­—","hashtags":["tag1","tag2","tag3","tag4","tag5"],"estimatedEngagement":"é ä¼°äº’å‹•èªªæ˜"}]}

## slides çµæ§‹
- page: é ç¢¼ï¼ˆ1é–‹å§‹ï¼‰
- type: "cover"=å°é¢ã€"content"=å…§å®¹é ã€"cta"=è¡Œå‹•å‘¼ç±²é ã€"quiz_question"=æ¸¬é©—é¡Œç›®ã€"quiz_result"=æ¸¬é©—çµæœ
- headline: ä¸»æ¨™é¡Œï¼ˆå¿…å¡«ï¼‰
- body: è©³ç´°å…§å®¹ï¼ˆcontent é å¿…é ˆ 50-80 å­—ï¼Œquiz_result é å¿…é ˆ 80-120 å­—ï¼‰

## æœ€çµ‚æª¢æŸ¥æ¸…å–®
ç”Ÿæˆå‰è«‹ç¢ºèªï¼š
1. æ¯ç¯‡è²¼æ–‡è‡³å°‘ 6 é ï¼ˆçŸ¥è­˜é¡ 7 é ä»¥ä¸Šï¼Œæ¸¬é©—é¡ 8 é ä»¥ä¸Šï¼‰
2. æ¯å€‹ content é çš„ body æœ‰ 50-80 å­—
3. å…§å®¹æœ‰å¯¦éš›åƒ¹å€¼ï¼Œä¸æ˜¯ç©ºæ³›çš„å»¢è©±
4. å°é¢ä½¿ç”¨äº†é«˜äº’å‹•å…¬å¼
5. æœ‰æ˜ç¢ºçš„ CTA å¼•å°äº’å‹•
6. æ¸¬é©—é¡å¿…é ˆéµå®ˆã€Œæ²’æœ‰æ­£ç¢ºç­”æ¡ˆã€åŸå‰‡ï¼Œé¸é …å¿…é ˆä¸­æ€§ç­‰åƒ¹`

export async function POST(request: NextRequest) {
  try {
    // æª¢æŸ¥èªè­‰å’Œé¡åº¦
    const authResult = await checkApiAuth(request, 'carousel')
    if (!authResult.allowed) {
      return authError(authResult)
    }

    const { niche, targetAudience, topic, carouselCount = 10 } = await request.json()

    if (!niche) {
      return NextResponse.json({ error: "è«‹æä¾›ä½ çš„é ˜åŸŸ/å®šä½" }, { status: 400 })
    }

    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    })

    // æ ¹æ“šè¨‚é–±ç­‰ç´šé¸æ“‡æ¨¡å‹ï¼špro/lifetime ç”¨ gpt-4oï¼Œå…¶ä»–ç”¨ gpt-4o-mini
    const isPremium = authResult.tier === 'pro' || authResult.tier === 'lifetime'
    const modelToUse = isPremium ? 'gpt-4o' : 'gpt-4o-mini'

    const userPrompt = `é ˜åŸŸï¼š${niche}
å—çœ¾ï¼š${targetAudience || "ä¸€èˆ¬"}
${topic ? `ä¸»é¡Œï¼š${topic}` : ""}

ç”Ÿæˆ${carouselCount}çµ„é«˜å“è³ªè¼ªæ’­è²¼æ–‡ï¼š

ã€é‡è¦è¦æ±‚ã€‘
1. æ¯ç¯‡å¿…é ˆ 6-10 é ï¼ˆçŸ¥è­˜é¡ 7-10 é ï¼Œæ¸¬é©—é¡ 8-10 é ï¼‰
2. æ¯å€‹ content é çš„ body å¿…é ˆæœ‰ 50-80 å­—ï¼Œå…§å®¹è¦æœ‰æ·±åº¦
3. å°é¢å¿…ç”¨é«˜äº’å‹•å…¬å¼ï¼ˆæ•¸å­—/å°æ¯”/å•å¥/ç—›é»/å¥½å¥‡ï¼‰
4. ç¦æ­¢ä½¿ç”¨ XXã€OO ç­‰ placeholderï¼Œæ‰€æœ‰å…§å®¹å¿…é ˆå…·é«”
5. æ¶µè“‹çŸ¥è­˜/æƒ…æ„Ÿ/å…±é³´/æ¸¬é©—å¤šç¨®é¡å‹ï¼Œå…§å®¹è¦å¤šå…ƒ

ã€æ¸¬é©—é¡è²¼æ–‡ç‰¹åˆ¥è¦æ±‚ã€‘
âš ï¸ æ¸¬é©—çš„æ ¸å¿ƒæ˜¯ã€Œæ²’æœ‰æ­£ç¢ºç­”æ¡ˆã€ï¼
- æ¯å€‹é¸é …éƒ½å¿…é ˆæ˜¯ä¸­æ€§ç­‰åƒ¹çš„ï¼Œä¸èƒ½æœ‰æ˜é¡¯ã€Œå¥½å£ã€ä¹‹åˆ†
- ç”¨æƒ…å¢ƒå¼å•é¡Œï¼ˆã€Œé€±äº”æ™šä¸Šä½ æœƒ...ã€ï¼‰è€ŒéæŠ½è±¡å•é¡Œï¼ˆã€Œä½ è¦ºå¾—è‡ªå·±...ã€ï¼‰
- çµæœæ˜¯ã€Œé¡å‹ã€è€Œéã€Œè©•åƒ¹ã€ï¼Œè®“æ¯ç¨®çµæœéƒ½è®“äººè¦ºå¾—è¢«ç†è§£
- çµæœè¦æœ‰ã€Œè¢«çœ‹ç©¿ã€çš„æ„Ÿè¦ºï¼ŒåŠ å…¥å…·é«”çš„å°ç´°ç¯€è®“äººé©šå–œ

ã€å…§å®¹æ·±åº¦ç¯„ä¾‹ã€‘
âœ… å¥½çš„ bodyï¼šã€Œèµ·åºŠå¾Œå…ˆå–300mlæº«æ°´ï¼Œå¹«åŠ©å–šé†’è…¸èƒƒã€‚é£¯å‰30åˆ†é˜å–ä¸€æ¯ï¼Œå¢åŠ é£½è¶³æ„Ÿé‚„èƒ½å¹«åŠ©æ¶ˆåŒ–ã€‚é‹å‹•å‰å¾Œå„è£œå……200mlï¼Œé¿å…è„«æ°´å½±éŸ¿è¡¨ç¾ã€
âŒ å·®çš„ bodyï¼šã€Œå¤šå–æ°´å°èº«é«”å¥½ã€

è¼¸å‡ºJSONã€‚`

    const completion = await openai.chat.completions.create({
      model: modelToUse,
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt }
      ],
      temperature: 0.85,
      max_tokens: isPremium ? 16000 : 10000,
      response_format: { type: "json_object" }
    })

    const content = completion.choices[0]?.message?.content || "{}"

    try {
      const result = JSON.parse(content)

      // è¨˜éŒ„ä½¿ç”¨é‡
      await recordUsage(request, authResult.userId, 'carousel')

      // è¿½è¹¤ API æˆæœ¬
      if (completion.usage) {
        await trackApiCost({
          userId: authResult.userId || undefined,
          featureType: 'carousel',
          modelName: modelToUse,
          inputTokens: completion.usage.prompt_tokens,
          outputTokens: completion.usage.completion_tokens,
        })
      }

      // Pro/Lifetime ç”¨æˆ¶ä¿å­˜ç”Ÿæˆè¨˜éŒ„åˆ° generations è¡¨
      let generationId: string | null = null
      if (isPremium && result.carouselPosts?.length > 0) {
        generationId = await saveGeneration({
          userId: authResult.userId,
          featureType: 'carousel',
          title: `è¼ªæ’­è²¼æ–‡ - ${niche}ï¼ˆ${result.carouselPosts.length}çµ„ï¼‰`,
          inputData: { niche, targetAudience, topic, carouselCount },
          outputData: result,
          modelUsed: modelToUse,
          tokensUsed: completion.usage?.total_tokens
        })
      }

      return NextResponse.json({
        ...result,
        generationId,
        _creditConsumed: true,
        _featureType: 'carousel',
        _remainingCredits: authResult.remainingCredits,
        _isGuest: authResult.isGuest
      })
    } catch {
      return NextResponse.json({
        carouselPosts: [],
        error: "è§£æçµæœæ™‚ç™¼ç”ŸéŒ¯èª¤"
      })
    }
  } catch (error) {
    console.error("API Error:", error)
    return NextResponse.json(
      { error: "ç”Ÿæˆè¼ªæ’­è²¼æ–‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦" },
      { status: 500 }
    )
  }
}
